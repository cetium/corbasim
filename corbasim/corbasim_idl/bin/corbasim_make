#!/bin/sh

BASEDIR=`dirname $0`
BASEDIR=`cd $BASEDIR && pwd`
INSTALLPREFIX=`cd $BASEDIR/.. && pwd`

USAGE()
{
    echo ""
    echo "USAGE: "
    echo "    corbasim_make [-h] [-n <project name>] <idl file> ..."
    echo ""
    echo "OPTIONS:"
    echo "    -n  project name"
    echo "    -h  help"
    echo "    -D  preprocessor definition"
    echo "    -I  preprocessor include directory"
    echo ""
    exit $E_OPTERROR    # Exit and explain usage, if no argument(s) given.
}

# Default options
PROJECTNAME=corbasim_plugin
PREPROCESSOROPTIONS=

# Processing arguments
while getopts ":n:h:D:I:" Option
do
    case $Option in
        n    ) PROJECTNAME=$OPTARG;;
        h    ) USAGE
               exit 0;;
        D    ) PREPROCESSOROPTIONS="$PREPROCESSOROPTIONS -D$OPTARG" ;;
        I    ) PREPROCESSOROPTIONS="$PREPROCESSOROPTIONS -I$OPTARG" ;;
        *    ) echo ""
               echo "Invalid option."
               USAGE   # DEFAULT
    esac
done

shift $(($OPTIND - 1))

if [ $# -lt 1 ]; then
    echo "No input files"
    exit 1
fi

INPUTFILES=
for i in $@; do
    # Avoiding loops
    if [ "$i" != "$PROJECTNAME.idl" ]; then
        INPUTFILES="$INPUTFILES $i"
    fi

    if [ ! -f $i ]; then
        echo "File $i does not exist"
        exit 1
    fi
done

echo "Project: $PROJECTNAME"
echo "Processing files: $INPUTFILES"

cat $INPUTFILES | cpp -E $PREPROCESSOROPTIONS | grep -v ^# > $PROJECTNAME.idl

echo "Generated temporary file: $PROJECTNAME.idl"

$BASEDIR/corbasim_idl $PROJECTNAME.idl

echo "Generating CMakeLists.txt file..."

echo """
cmake_minimum_required(VERSION 2.6)
project(__PROJECTNAME__ CXX C)

set(CMAKE_MODULE_PATH __INSTALLPREFIX__/share/corbasim/cmake)

include(CorbasimEnv)

include(__PROJECTNAME__.cmake)

""" | sed -e 's/__PROJECTNAME__/'"${PROJECTNAME}"'/g'       \
    | sed -e 's|__INSTALLPREFIX__|'${INSTALLPREFIX}'|g'   \
    > CMakeLists.txt

# Compilation
# mkdir -p build
# cd build
# cmake .. && make 
# cd ..

